/*global exports,require,process*/(function () {    "use strict";    var config = require("./config"),        status = require("./status"),        data = require("./data"),        utils = require("./utils"),        domain = require("domain");    /**     * Init     * @param req     * @param res     * @param next     */    exports.init = function (req, res, next) {        res.setHeader('X-Powered-By', 'ng-nice');        req.context = {            operationId: utils.guid()        };        var uid = req.signedCookies[config.sessionKey];        if (uid) {            data.User.get_by_id(uid, function (err, user) {                if (err || !user) {                    res.locals.is_authorized = false;                    next();                    return;                }                res.locals.user = user.makeSimple();                req.user = res.locals.user;                res.locals.is_authorized = true;                next();            });        } else {            res.locals.is_authorized = false;            next();        }    };    /**     * check auth     * @param req     * @param res     * @param next     */    exports.check_auth = function (req, res, next) {        if (res.locals.is_authorized) {            next();        } else {            res.send({code: status.error.permission_deny});        }    };    exports.domainMiddleware = function (req, res, next) {        var d = domain.create();        d.add(req);        d.add(res);        d.on('error', function (err) {            res.setHeader('Connection', 'close');            next(err);        });        d.run(next);    };    exports.errorHandler = function (error, req, res, next) {        console.error("request[%s] %s", req.context.operationId, error);        if (req.url.indexOf("/api") >= 0) {            return res.send({code: status.error.server_error});        } else {            return res.render('home/error.html', { title: '服务器异常', current_nav: "error"});        }    };    exports.passport = require("./passport.js");})();